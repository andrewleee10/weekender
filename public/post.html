<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
  <link rel="stylesheet" href="./assets/css/style.css">
  <title>Post</title>
</head>

<body>
  <!-- Nav Bar -->
  <nav class="navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="">
        <img src="./assets/images/weekndrLogoText.png" alt="logo">
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navContent">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navContent" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item navLeft" id="explore">Explore</a>
        <a class="navbar-item navLeft">Maps</a>
        <a class="navbar-item navLeft" id="profile">Profile</a>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons" id="navbarRight">
            <!-- <a class="button signBtn"><strong>Sign up</strong></a>
            <a class="button is-white">Log in</a> -->
            <!-- <a class="button signBtn"><strong>Sign out</strong></a> -->
          </div>
        </div>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="container has-text-centered" id="title">
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-4 is-offset-2 Description" >
          <div id="description"></div>
          <div id="attending"></div>          
        </div>
        <div class="column is-4 ">
          <div class="card">
            <header class="card-header">
              <p class="card-header-title deetsHeader">
                Deets:
              </p>
            </header>
            <div class="card-content" id="details">
            </div>
            <footer class="card-footer" id="attendBtn">
              <button class="button is-medium is-fullwidth signBtn" id="goingBtn">Going</button>
            </footer>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-8 is-offset-2">
          <div class="box commentHeader">
            <h1 class="title is-size-4  ">Comments:</h1>
          </div>
          <ul id="commentList"></ul>
          <div id="commentSection">          
            <div class="field">
              <label class="label">New Comment</label>
              <div class="control">
                <textarea class="textarea is-fullwidth" id="commentContent" rows="5"></textarea>
              </div>
            </div>

            <div class="field">
              <div class="control">
                <button class="button signBtn" id="makeComment">Post Comment</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="assets/apps/hamburger.js"></script>
  <script src="assets/apps/navBtns.js"></script>
  <script>

    let postID = localStorage.getItem('post_id')

    axios.get(`/api/posts/${postID}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
      .then(({data: posts}) => {

        let postDT = posts.dateTime.split('T')
        let timeValue = timeConvert(postDT[1])
        

        document.getElementById('title').innerHTML = `
          <h1 class="title is-1">${posts.title}</h1>
          <h2 class="subtitle is-3">
            <strong>Hosted by: ${posts.User.username}</strong>
          </h2>
        `
        document.getElementById('description').innerHTML = `
          <h1 class="is-size-4 has-text-weight-semibold">Description:</h1>
            <p>${posts.description}</p>
          <br>
        `
        document.getElementById('details').innerHTML = `
          <div class="content">
            <p class="has-text-weight-medium">Date:</p>
            <p>
              ${postDT[0]}
              <br>
              ${timeValue}
            </p>
            <p class="has-text-weight-medium">Location:</p>
            <p>
              ${posts.location}<br>
            </p>
          </div>
        `
      })
      .catch(err => console.log(err))

    axios.get(`/api/comments/${postID}`)
      .then(( { data } ) => {

        data.forEach(elem => {
          let commentDT = elem.time_posted.split('T')
          let timeValue = timeConvert(commentDT[1])

          document.getElementById('commentList').innerHTML += `
          <li>
              <strong class="username"> ${elem.User.username} </strong>
              <p> ${elem.text}</p>
              <small class="has-text-weight-light"> ${timeValue} ${commentDT[0]}</small>
              <hr>
            </li>
          `
        })
        

      })
      .catch(err => console.log(err))

      axios.get(`/api/isGoings/${postID}`)
        .then(({data}) => {
          let attendees = ''

          data.forEach(elem => {
            attendees += `${elem.User.username}, `
          })
          document.getElementById('attending').innerHTML = `
          <h1 class="is-size-5 has-text-weight-semibold">Attendees:</h1>
          <p>${attendees}</p>
          ` 
        })
        .catch(err => console.log(err))

      axios.get(`/api/isGoings/already/${postID}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
      })
        .then(user => {
          if(user.data === null) {
            document.getElementById('attendBtn').innerHTML =`
            <button class="button is-medium is-fullwidth signBtn" id="goingBtn">Going</button>`
          }else {
            document.getElementById('attendBtn').innerHTML = `
            <button class="button is-medium is-fullwidth is-success" id="goingBtn" disabled>Attending</button>`
          }
        })
        .catch(err => console.log(err))

    const timeConvert = (justTime) => {
      /////////////////////////////  code taken from https://stackoverflow.com/questions/29206453/best-way-to-convert-military-time-to-standard-time-in-javascript/29206663 

      let time = justTime // your input

      time = time.split(':') // convert to array

      // fetch
      let hours = Number(time[0])
      let minutes = Number(time[1])

      // calculate
      let timeValue

      if (hours > 0 && hours <= 12) {
        timeValue = "" + hours
      } else if (hours > 12) {
        timeValue = "" + (hours - 12);
      } else if (hours === 0) {
        timeValue = "12"
      }

      timeValue += (minutes < 10) ? ":0" + minutes : ":" + minutes  // get minutes
      timeValue += (hours >= 12) ? " P.M." : " A.M."  // get AM/PM

      return timeValue
        /////////////////////////////
    }


    document.getElementById('goingBtn').addEventListener('click', () => {
      let newGoing = {
        check_going: true,
        post_id: parseInt(postID)
      }
      axios.post('/api/isGoings', newGoing, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
        .then( window.location = '/post')
        .catch(err => console.log(err))
    })

    document.getElementById('makeComment').addEventListener('click', () => {
      let newComment = {
        text: document.getElementById('commentContent').value,
        post_id: postID
      }

      axios.post('/api/comments', newComment, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
        .then(({ data }) => {
          console.log(data)
          document.getElementById('commentContent').value = ''
          window.location = '/post'
        })
        .catch(err => console.log(err))
    })

  </script>
  
</body>

</html>